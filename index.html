<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zootopia: Final Edition</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Orbitron:wght@700&display=swap');
        
        :root { --blue: #1A5CC7; --gold: #FFD700; --accent: #FF8D29; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Fredoka', sans-serif; background: var(--blue);
            color: white; margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* –®–ê–ü–ö–ê */
        .header { text-align: center; padding-top: calc(env(safe-area-inset-top) + 10px); z-index: 100; background: rgba(0,0,0,0.1); padding-bottom: 10px; }
        .score { font-family: 'Orbitron'; font-size: 42px; line-height: 1; }
        .currency { font-family: 'Orbitron'; font-size: 14px; color: var(--gold); }

        /* –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ */
        .content { flex-grow: 1; position: relative; overflow: hidden; }
        .tab-panel { display: none; height: 100%; width: 100%; padding: 20px; overflow-y: auto; }
        .tab-panel.active { display: flex; flex-direction: column; }

        /* –ò–ì–†–ê (–ì–õ–ê–í–ù–ê–Ø) */
        .game-area { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: space-around; }
        
        .bubble-btn {
            position: absolute; background: white; color: #E57373; font-weight: 600;
            padding: 8px 15px; border-radius: 20px; font-size: 12px; text-align: center;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.2); animation: float 3s infinite ease-in-out;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        .character-box { position: relative; width: 60vw; max-width: 250px; transition: 0.1s; }
        .character-box:active { transform: scale(0.92); }
        .main-pet { width: 100%; height: auto; z-index: 5; position: relative; }
        .nft-overlay { position: absolute; inset: 0; z-index: 10; pointer-events: none; display: none; }
        .nft-overlay.visible { display: block; }

        /* –≠–ù–ï–†–ì–ò–Ø */
        .energy-container { width: 90%; background: rgba(0,0,0,0.3); border-radius: 20px; padding: 10px; margin-bottom: 10px; }
        .energy-bar { width: 100%; height: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
        .energy-fill { height: 100%; background: linear-gradient(90deg, #FFEF5E, #FF8D29); width: 100%; transition: 0.3s; }

        /* –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ (–†–ê–ó–î–ï–õ–´) */
        .nav-bar { 
            height: 80px; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px);
            display: flex; padding-bottom: env(safe-area-inset-bottom); border-top: 1px solid rgba(255,255,255,0.1);
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; opacity: 0.6; }
        .nav-item.active { opacity: 1; color: var(--gold); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }

        /* –ö–ê–†–¢–û–ß–ö–ò –í –°–ü–ò–°–ö–ê–• */
        .card { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .btn-action { background: var(--gold); border: none; padding: 10px 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* –ú–ò–ù–ò-–ò–ì–†–ê */
        .match3-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; }
        .cell { aspect-ratio: 1; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    </style>
</head>
<body>

<header class="header">
    <div class="score" id="bones">0</div>
    <div class="currency">$ZOO: <span id="zoo-val">0.0000</span></div>
</header>

<div class="content">
    <div id="tab-main" class="tab-panel active">
        <div class="game-area">
            <div class="bubble-btn" style="top:10%; left:5%" onclick="showTab('tab-top')">üèÜ –¢–û–ü</div>
            <div class="bubble-btn" style="top:10%; right:5%" onclick="tonConnectUI.openModal()">üí≥ –ö–û–®–ï–õ–ï–ö</div>
            <div class="bubble-btn" style="top:30%; left:2%" onclick="showTab('tab-news')">üîî –ù–û–í–û–°–¢–ò</div>
            
            <div id="evo-label" style="font-size:14px; font-weight:600; opacity:0.8;">–ú–∞–ª—ã—à –¢–∞–∫—Å–∞</div>
            
            <div class="character-box" onclick="handleTap()">
                <img src="nft_glasses.png" id="nft-glasses" class="nft-overlay">
                <img src="nft_hat.png" id="nft-hat" class="nft-overlay">
                <img src="dachshund.png" id="pet-img" class="main-pet">
            </div>

            <div class="energy-container">
                <div style="font-size:12px; margin-bottom:5px; font-weight:bold;">‚ö° <span id="en-cur">1000</span> / 1000</div>
                <div class="energy-bar"><div class="energy-fill" id="en-fill"></div></div>
            </div>
        </div>
    </div>

    <div id="tab-shop" class="tab-panel">
        <h2>–ú–∞–≥–∞–∑–∏–Ω –ë—É—Å—Ç–æ–≤</h2>
        <div class="card">
            <div><b>–°–∏–ª–∞ —Ç–∞–ø–∞</b><br><small id="tap-price">500 ü¶¥</small></div>
            <button class="btn-action" onclick="upgradeTap()">Lvl <span id="tap-lvl">1</span></button>
        </div>
        <h2>NFT –ì–∞—Ä–¥–µ—Ä–æ–±</h2>
        <div class="card">
            <div><b>–û—á–∫–∏ Cyber</b><br><small>10 $ZOO</small></div>
            <button class="btn-action" onclick="buyNFT('glasses', 10)">–ö—É–ø–∏—Ç—å</button>
        </div>
    </div>

    <div id="tab-game" class="tab-panel">
        <h2>Zootopia Match</h2>
        <p>–ù–∞–∂–∏–º–∞–π –Ω–∞ –∫–æ—Å—Ç–æ—á–∫–∏ –∏ –ø–æ–ª—É—á–∞–π $ZOO!</p>
        <div id="grid" class="match3-grid"></div>
    </div>

    <div id="tab-news" class="tab-panel">
        <h2>–ù–æ–≤–æ—Å—Ç–∏</h2>
        <div class="card"><div><b>–¥–∏–∑–∞–π–Ω –æ–±–Ω–æ–≤–ª–µ–Ω!</b><br><small>–¢–µ–ø–µ—Ä—å –Ω–∞–≤–∏–≥–∞—Ü–∏—è –≤–Ω–∏–∑—É.</small></div></div>
        <div class="card"><div><b>TON –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</b><br><small>–ö–æ—à–µ–ª–µ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç.</small></div></div>
    </div>

    <div id="tab-top" class="tab-panel">
        <h2>–¢–æ–ø —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>
        <div id="top-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
</div>

<nav class="nav-bar">
    <div class="nav-item active" onclick="showTab('tab-main', this)"><i class="fas fa-paw"></i>–ì–ª–∞–≤–Ω–∞—è</div>
    <div class="nav-item" onclick="showTab('tab-shop', this)"><i class="fas fa-shopping-cart"></i>–ú–∞–≥–∞–∑–∏–Ω</div>
    <div class="nav-item" onclick="showTab('tab-game', this)"><i class="fas fa-th"></i>3 –≤ —Ä—è–¥</div>
    <div class="nav-item" onclick="showTab('tab-top', this)"><i class="fas fa-trophy"></i>–¢–æ–ø</div>
</nav>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: 'https://raw.githubusercontent.com/ton-connect/demo-dapp-with-react-ui/master/public/tonconnect-manifest.json',
    });

    let state = { bones: 0, zoo: 0, energy: 1000, tapLvl: 1, ownedNFTs: [] };

    function handleTap() {
        if (state.energy > 0) {
            state.bones += state.tapLvl;
            state.zoo += (state.tapLvl * 0.0001);
            state.energy -= 2;
            updateUI();
            tg.HapticFeedback.impactOccurred('medium');
            checkEvolution();
        }
    }

    function upgradeTap() {
        let cost = state.tapLvl * 500;
        if (state.bones >= cost) {
            state.bones -= cost;
            state.tapLvl++;
            updateUI();
        }
    }

    function buyNFT(id, price) {
        if (state.zoo >= price && !state.ownedNFTs.includes(id)) {
            state.zoo -= price;
            state.ownedNFTs.push(id);
            document.getElementById('nft-' + id).classList.add('visible');
            updateUI();
            tg.showAlert("–ü—Ä–µ–¥–º–µ—Ç –Ω–∞–¥–µ—Ç!");
        }
    }

    function checkEvolution() {
        const label = document.getElementById('evo-label');
        if (state.tapLvl >= 10) label.innerText = "–ö–∏–±–µ—Ä-–¢–∞–∫—Å–∞ üòé";
        if (state.tapLvl >= 20) label.innerText = "–¢–∞–∫—Å–∞-–°—É–ø–µ—Ä–≥–µ—Ä–æ–π ü¶∏";
    }

    function showTab(tabId, el) {
        document.querySelectorAll('.tab-panel').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if (el) el.classList.add('active');
        if (tabId === 'tab-game') initGame();
    }

    function initGame() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        for (let i = 0; i < 25; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.innerText = 'ü¶¥';
            cell.onclick = () => {
                state.zoo += 0.001;
                cell.style.opacity = '0.5';
                updateUI();
            };
            grid.appendChild(cell);
        }
    }

    function updateUI() {
        document.getElementById('bones').innerText = Math.floor(state.bones).toLocaleString();
        document.getElementById('zoo-val').innerText = state.zoo.toFixed(4);
        document.getElementById('en-cur').innerText = state.energy;
        document.getElementById('en-fill').style.width = (state.energy / 10) + '%';
        document.getElementById('tap-lvl').innerText = state.tapLvl;
        document.getElementById('tap-price').innerText = (state.tapLvl * 500) + " ü¶¥";
    }

    setInterval(() => {
        if (state.energy < 1000) { state.energy = Math.min(1000, state.energy + 5); updateUI(); }
    }, 2000);

    updateUI();
</script>
</body>
</html>
