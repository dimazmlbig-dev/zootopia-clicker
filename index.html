<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zootopia: NFT Marketplace</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@2.0.3/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Orbitron:wght@700&display=swap');

        :root { 
            --bg-dark: #0f172a; --card-bg: rgba(30, 41, 59, 0.7); 
            --accent: #3b82f6; --gold: #fbbf24; --text-sec: #94a3b8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            color: white; margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- –ó–ê–ì–†–£–ó–û–ß–ù–´–ô –≠–ö–†–ê–ù --- */
        #loader {
            position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .loader-spin { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-top: 5px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- –•–ï–î–ï–† --- */
        .header { padding-top: calc(env(safe-area-inset-top) + 15px); text-align: center; z-index: 10; }
        .balance-container { display: inline-block; background: rgba(0,0,0,0.4); padding: 5px 20px; border-radius: 30px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
        .score { font-family: 'Orbitron'; font-size: 32px; letter-spacing: 1px; }
        .zoo-sub { color: var(--gold); font-size: 14px; font-weight: 600; }

        /* --- –û–°–ù–û–í–ù–ê–Ø –°–¶–ï–ù–ê --- */
        .main-view { flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* –ü–µ—Ä—Å–æ–Ω–∞–∂ */
        .character-wrapper { position: relative; width: 70vw; max-width: 300px; aspect-ratio: 1; }
        .pet-base { width: 100%; filter: drop-shadow(0 0 30px rgba(59, 130, 246, 0.3)); transition: transform 0.1s; }
        .pet-base:active { transform: scale(0.97); }
        .nft-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; opacity: 0; transition: opacity 0.3s; width: 100%; }
        .nft-layer.visible { opacity: 1; }

        /* –û–±–ª–∞—á–∫–∞ (Bubbles) */
        .bubble {
            position: absolute; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 16px;
            padding: 8px 12px; font-size: 11px; font-weight: 600; color: white;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; min-width: 80px;
        }
        .bubble i { font-size: 18px; color: var(--accent); }
        .b-left { left: 15px; } .b-right { right: 15px; }
        
        .pos-1 { top: 15%; } .pos-2 { top: 35%; } .pos-3 { top: 55%; }

        /* --- –≠–ù–ï–†–ì–ò–Ø --- */
        .energy-cont { width: 90%; max-width: 350px; margin-bottom: 20px; background: rgba(0,0,0,0.5); border-radius: 20px; padding: 4px; border: 1px solid rgba(255,255,255,0.05); }
        .energy-bar { height: 8px; background: #1e293b; border-radius: 10px; overflow: hidden; }
        .energy-fill { height: 100%; width: 100%; background: linear-gradient(90deg, var(--accent), #60a5fa); transition: width 0.3s; }
        .energy-text { text-align: center; font-size: 10px; color: var(--text-sec); margin-top: 4px; }

        /* --- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê (Modern Glass) --- */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px);
            z-index: 2000; display: none; flex-direction: column; opacity: 0; transition: opacity 0.3s;
        }
        .modal.active { display: flex; opacity: 1; }
        .modal-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        .close-icon { font-size: 24px; color: var(--text-sec); cursor: pointer; }

        /* --- NFT –ö–ê–†–¢–û–ß–ö–ò --- */
        .nft-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .nft-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 15px;
            display: flex; flex-direction: column; align-items: center; text-align: center; position: relative;
        }
        .nft-img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px; }
        .nft-qr { width: 60px; height: 60px; margin: 10px 0; border-radius: 8px; mix-blend-mode: screen; background: white; padding: 2px;}
        .nft-id { font-family: 'Orbitron'; font-size: 10px; color: var(--gold); margin-bottom: 5px; letter-spacing: 1px; }
        .badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); margin-top: 5px; }
        
        .btn { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 10px; width: 100%; font-weight: 600; margin-top: 10px; cursor: pointer; }
        .btn:disabled { background: #334155; color: #64748b; }

        /* --- –¢–ê–ë–´ –í NFT --- */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; text-align: center; background: rgba(255,255,255,0.05); border-radius: 10px; font-size: 12px; cursor: pointer; }
        .tab.active { background: var(--accent); }

        /* --- –ê–Ω–∏–º–∞—Ü–∏—è –≤—Å–ø–ª—ã—Ç–∏—è —Ü–∏—Ñ—Ä --- */
        @keyframes floatUp { 0% { opacity:1; transform:translateY(0); } 100% { opacity:0; transform:translateY(-60px); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="loader-spin"></div>
    <div style="margin-top: 20px; font-family: 'Orbitron'">ZOOTOPIA</div>
</div>

<header class="header">
    <div class="balance-container">
        <div class="score" id="bones-display">0</div>
        <div class="zoo-sub">$ZOO: <span id="zoo-display">0.0000</span></div>
    </div>
</header>

<main class="main-view">
    <div class="bubble b-left pos-1" onclick="openModal('top-modal')"><i class="fas fa-trophy"></i>–¢–û–ü</div>
    <div class="bubble b-left pos-2" onclick="openModal('news-modal')"><i class="fas fa-newspaper"></i>–ò–Ω—Ñ–æ</div>
    <div class="bubble b-left pos-3" onclick="openModal('game-modal')"><i class="fas fa-gamepad"></i>–ò–≥—Ä–∞</div>

    <div class="bubble b-right pos-1" onclick="openNFTModal()"><i class="fas fa-fingerprint"></i>NFT</div>
    <div class="bubble b-right pos-2" id="ton-btn"><i class="fas fa-wallet"></i>Wallet</div>
    <div class="bubble b-right pos-3" onclick="openModal('boost-modal')"><i class="fas fa-bolt"></i>–ë—É—Å—Ç—ã</div>

    <div class="character-wrapper" id="tap-zone">
        <img src="nft_glasses.png" id="layer-glasses" class="nft-layer">
        <img src="nft_hat.png" id="layer-hat" class="nft-layer">
        <img src="dachshund.png" class="pet-base">
    </div>

    <div style="margin-top: 20px; width:100%; display:flex; justify-content:center;">
        <div class="energy-cont">
            <div class="energy-bar"><div class="energy-fill" id="en-fill"></div></div>
            <div class="energy-text"><span id="en-curr">1000</span> / 1000 ‚ö°</div>
        </div>
    </div>
</main>

<div id="nft-modal" class="modal">
    <div class="modal-header">
        <h3>NFT Assets</h3>
        <i class="fas fa-times close-icon" onclick="closeModal('nft-modal')"></i>
    </div>
    <div class="modal-body">
        <div class="tabs">
            <div class="tab active" onclick="switchNftTab('market')">–ú–∞—Ä–∫–µ—Ç</div>
            <div class="tab" onclick="switchNftTab('inventory')">–ú–æ–∏ NFT</div>
        </div>

        <div id="view-market" class="nft-grid">
            <div class="nft-card">
                <img src="nft_glasses.png" class="nft-img">
                <div style="font-weight:bold">Cyber Glasses</div>
                <div class="badge">Common</div>
                <div style="font-size:10px; color:#94a3b8; margin:5px 0">+5 –∫ —Ç–∞–ø—É</div>
                <button class="btn" onclick="mintNFT('glasses', 'Cyber Glasses', 10, 5)">10 $ZOO</button>
            </div>
            <div class="nft-card">
                <img src="nft_hat.png" class="nft-img">
                <div style="font-weight:bold">Sheriff Hat</div>
                <div class="badge" style="background:rgba(251, 191, 36, 0.2); color:#fbbf24">Rare</div>
                <div style="font-size:10px; color:#94a3b8; margin:5px 0">+15 –∫ —Ç–∞–ø—É</div>
                <button class="btn" onclick="mintNFT('hat', 'Sheriff Hat', 25, 15)">25 $ZOO</button>
            </div>
        </div>

        <div id="view-inventory" class="nft-grid" style="display:none;"></div>
    </div>
</div>

<div id="game-modal" class="modal">
    <div class="modal-header">
        <h3>Mining Game</h3>
        <i class="fas fa-times close-icon" onclick="closeModal('game-modal')"></i>
    </div>
    <div class="modal-body" style="display:flex; flex-direction:column; align-items:center;">
        <div id="game-grid" style="display:grid; grid-template-columns:repeat(5, 1fr); gap:8px; width:100%; max-width:300px;"></div>
        <p style="margin-top:20px; color:var(--text-sec)">–î–æ–±—ã—Ç–æ: <span id="game-score" style="color:white">0</span> $ZOO</p>
    </div>
</div>

<div id="boost-modal" class="modal">
    <div class="modal-header">
        <h3>Upgrade Center</h3>
        <i class="fas fa-times close-icon" onclick="closeModal('boost-modal')"></i>
    </div>
    <div class="modal-body">
        <div class="nft-card" style="flex-direction:row; justify-content:space-between; text-align:left;">
            <div>
                <div style="font-weight:bold">Multitap</div>
                <div style="font-size:11px; color:var(--text-sec)">–£—Ä–æ–≤–µ–Ω—å: <span id="tap-lvl">1</span></div>
            </div>
            <button class="btn" style="width:auto; padding:5px 15px;" onclick="upgradeTap()">Upgrade <br><small id="upg-cost">500</small> ü¶¥</button>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // TonConnect
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: 'https://raw.githubusercontent.com/ton-connect/demo-dapp-with-react-ui/master/public/tonconnect-manifest.json',
        buttonRootId: 'ton-btn'
    });

    // --- STATE ---
    let state = {
        bones: 1000,
        zoo: 50.00,
        energy: 1000,
        tapLvl: 1,
        tapPower: 1, // –ë–∞–∑–æ–≤–∞—è —Å–∏–ª–∞ + NFT
        inventory: [] // –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ {id, type, name, qrUrl, power}
    };

    // --- UTILS ---
    function generateUUID() {
        return 'ZOO-' + Math.random().toString(36).substr(2, 6).toUpperCase();
    }

    function generateQR(data) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞ (–Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –±–µ–∑ –ª–∏—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫)
        return `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${data}&color=3b82f6&bgcolor=1e293b`;
    }

    // --- CORE LOGIC ---
    function updateUI() {
        document.getElementById('bones-display').innerText = Math.floor(state.bones).toLocaleString();
        document.getElementById('zoo-display').innerText = state.zoo.toFixed(4);
        document.getElementById('en-curr').innerText = Math.floor(state.energy);
        document.getElementById('en-fill').style.width = (state.energy / 1000 * 100) + '%';
        document.getElementById('tap-lvl').innerText = state.tapLvl;
        document.getElementById('upg-cost').innerText = state.tapLvl * 500;
    }

    // Tap System
    document.getElementById('tap-zone').addEventListener('touchstart', (e) => {
        e.preventDefault();
        if(state.energy >= 2) {
            // –†–∞—Å—á–µ—Ç —Å–∏–ª—ã: —É—Ä–æ–≤–µ–Ω—å + –±–æ–Ω—É—Å—ã –æ—Ç –Ω–∞–¥–µ—Ç—ã—Ö NFT (–º–æ–∂–Ω–æ —É—Å–ª–æ–∂–Ω–∏—Ç—å)
            let totalPower = state.tapLvl; 
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–¥–µ—Ç—ã—Ö NFT
            const wearingGlasses = document.getElementById('layer-glasses').classList.contains('visible');
            const wearingHat = document.getElementById('layer-hat').classList.contains('visible');
            if(wearingGlasses) totalPower += 5;
            if(wearingHat) totalPower += 15;

            state.bones += totalPower;
            state.zoo += (0.0001 * totalPower);
            state.energy -= 2;
            
            updateUI();
            tg.HapticFeedback.impactOccurred('light');

            // Floating Text
            let t = e.touches[0];
            let floatEl = document.createElement('div');
            floatEl.innerText = `+${totalPower}`;
            floatEl.style.position = 'fixed';
            floatEl.style.left = t.clientX + 'px';
            floatEl.style.top = t.clientY + 'px';
            floatEl.style.color = '#fbbf24';
            floatEl.style.fontWeight = '800';
            floatEl.style.zIndex = 1000;
            floatEl.style.animation = 'floatUp 0.8s forwards';
            document.body.appendChild(floatEl);
            setTimeout(()=>floatEl.remove(), 800);
        }
    });

    // --- NFT SYSTEM ---
    function openNFTModal() {
        document.getElementById('nft-modal').classList.add('active');
        renderInventory();
    }

    function switchNftTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if(tab === 'market') {
            document.getElementById('view-market').style.display = 'grid';
            document.getElementById('view-inventory').style.display = 'none';
            document.querySelector('.tab:first-child').classList.add('active');
        } else {
            document.getElementById('view-market').style.display = 'none';
            document.getElementById('view-inventory').style.display = 'grid';
            document.querySelectorAll('.tab')[1].classList.add('active');
            renderInventory();
        }
    }

    function mintNFT(type, name, price, power) {
        if(state.zoo >= price) {
            state.zoo -= price;
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
            const uniqueId = generateUUID();
            const qrCode = generateQR(uniqueId);
            
            const newItem = {
                uid: uniqueId,
                type: type,
                name: name,
                qr: qrCode,
                power: power,
                date: new Date().toLocaleDateString()
            };

            state.inventory.push(newItem);
            updateUI();
            
            tg.showPopup({
                title: '–ú–∏–Ω—Ç–∏–Ω–≥ —É—Å–ø–µ—à–µ–Ω!',
                message: `–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${name} ID: ${uniqueId}`,
                buttons: [{type: 'ok'}]
            });

            // –ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
            switchNftTab('inventory');
        } else {
            tg.showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ $ZOO!');
        }
    }

    function renderInventory() {
        const container = document.getElementById('view-inventory');
        container.innerHTML = '';

        if(state.inventory.length === 0) {
            container.innerHTML = '<div style="grid-column: span 2; text-align:center; padding:20px; color:#94a3b8">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</div>';
            return;
        }

        state.inventory.forEach((item, index) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–¥–µ—Ç –ª–∏ —ç—Ç–æ—Ç –¢–ò–ü –ø—Ä–µ–¥–º–µ—Ç–∞
            const isWearing = document.getElementById(`layer-${item.type}`).classList.contains('visible');
            // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –Ω–∞–¥–µ—Ç —Å–ª–æ–π –∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç —Ç–∞–∫–æ–≥–æ —Ç–∏–ø–∞ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ - –ø–æ–º–µ—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º (–º–æ–∂–Ω–æ —É—Å–ª–æ–∂–Ω–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫–æ–π ID)
            
            const card = document.createElement('div');
            card.className = 'nft-card';
            card.innerHTML = `
                <div class="nft-id">${item.uid}</div>
                <img src="${item.qr}" class="nft-qr" alt="QR">
                <div style="font-size:12px; font-weight:bold">${item.name}</div>
                <div style="font-size:9px; color:#94a3b8">${item.date}</div>
                <button class="btn" style="margin-top:8px; font-size:11px; background:${isWearing ? '#ef4444' : '#22c55e'}" 
                onclick="toggleWear('${item.type}')">
                    ${isWearing ? '–°–Ω—è—Ç—å' : '–ù–∞–¥–µ—Ç—å'}
                </button>
            `;
            container.appendChild(card);
        });
    }

    function toggleWear(type) {
        const layer = document.getElementById(`layer-${type}`);
        layer.classList.toggle('visible');
        renderInventory(); // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏
    }

    // --- GAME LOGIC (3-IN-ROW SIMPLIFIED) ---
    function initGame() {
        const grid = document.getElementById('game-grid');
        grid.innerHTML = '';
        const icons = ['üî∑', 'üî∂', 'ü¶¥', 'üçñ'];
        for(let i=0; i<20; i++) {
            let d = document.createElement('div');
            d.style = "aspect-ratio:1; background:rgba(255,255,255,0.05); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:24px; cursor:pointer;";
            d.innerText = icons[Math.floor(Math.random()*icons.length)];
            d.onclick = function() {
                this.style.transform = "scale(0)";
                setTimeout(() => {
                    this.innerText = icons[Math.floor(Math.random()*icons.length)];
                    this.style.transform = "scale(1)";
                }, 200);
                let score = document.getElementById('game-score');
                state.zoo += 0.005;
                score.innerText = (parseFloat(score.innerText) + 0.005).toFixed(3);
                updateUI();
                tg.HapticFeedback.selectionChanged();
            }
            grid.appendChild(d);
        }
    }

    // --- SYSTEM ---
    function openModal(id) { 
        document.getElementById(id).classList.add('active'); 
        if(id === 'game-modal') initGame();
    }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function upgradeTap() {
        let cost = state.tapLvl * 500;
        if(state.bones >= cost) {
            state.bones -= cost;
            state.tapLvl++;
            updateUI();
        }
    }

    // Init
    window.onload = () => {
        setTimeout(() => {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(()=>document.getElementById('loader').style.display='none', 500);
        }, 1500);
        setInterval(() => {
            if(state.energy < 1000) { state.energy++; updateUI(); }
        }, 1000);
        updateUI();
    };

</script>
</body>
</html>
