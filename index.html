<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zootopia Ultimate</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@400;600&display=swap');
        :root { --gold: #FFD700; --accent: #00FFFF; --bg: #0A0A12; --card: #1C1C2E; }
        
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; touch-action: none; user-select: none; }
        
        /* HEADER */
        .header { text-align: center; padding: 10px; background: rgba(0,0,0,0.9); border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 1000; }
        .league-info { font-size: 11px; color: var(--accent); font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .league-bar { width: 60%; height: 4px; background: #222; margin: 0 auto 10px; border-radius: 2px; overflow: hidden; }
        #league-progress { height: 100%; background: var(--gold); width: 0%; transition: 0.5s; }
        .balance { font-family: 'Orbitron'; font-size: 26px; color: var(--gold); }
        .zoo-balance { color: var(--accent); font-size: 12px; font-family: 'Orbitron'; }

        /* TABS */
        .tab-content { display: none; height: calc(100vh - 170px); overflow-y: auto; padding: 20px; padding-bottom: 100px; }
        .tab-content.active { display: block; }

        /* GAME TAB */
        .click-area { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 60vh; position: relative; }
        .pet-image { width: 250px; filter: drop-shadow(0 0 20px rgba(0,255,255,0.2)); transition: 0.05s; }
        .energy-container { position: absolute; bottom: 10px; width: 80%; text-align: center; }
        .energy-bar { width: 100%; height: 10px; background: #111; border-radius: 10px; overflow: hidden; border: 1px solid #333; }
        #energy-fill { height: 100%; background: var(--accent); width: 100%; transition: 0.2s; }

        /* CARDS & UI */
        .card { background: var(--card); border-radius: 15px; padding: 15px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .btn-action { background: var(--accent); color: black; border: none; padding: 10px 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        
        /* NFT & BOXES */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .nft-card { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid rgba(0,255,255,0.1); text-align: center; padding-bottom: 10px; }
        .nft-img-sm { width: 100%; height: 100px; object-fit: cover; }

        /* UNBOXING OVERLAY */
        #unboxing { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .box-anim { font-size: 80px; animation: shake 0.5s infinite; }
        @keyframes shake { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
        .reward-pop { transform: scale(0); transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center; }
        .reward-pop.show { transform: scale(1); }

        /* NAVIGATION */
        .nav { position: fixed; bottom: 0; width: 100%; display: flex; background: #000; padding: 12px 0; border-top: 1px solid #222; z-index: 1000; }
        .nav-item { flex: 1; text-align: center; color: #555; font-size: 10px; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 4px; }

        #loading { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; color: var(--gold); }
    </style>
</head>
<body>

<div id="loading"><h2>ZOOTOPIA...</h2></div>

<div id="unboxing">
    <div id="box-icon" class="box-anim">üéÅ</div>
    <div id="reward-info" class="reward-pop">
        <img id="rew-img" src="" style="width:150px; border-radius:20px; border:3px solid var(--accent);">
        <h2 id="rew-name" style="margin:10px 0;"></h2>
        <p id="rew-bonus" style="color:var(--accent);"></p>
        <button class="btn-action" onclick="closeUnboxing()">–ó–ê–ë–†–ê–¢–¨</button>
    </div>
</div>

<div class="header">
    <div class="league-info" id="league-name">–ë—Ä–æ–Ω–∑–æ–≤–∞—è –õ–∏–≥–∞</div>
    <div class="league-bar"><div id="league-progress"></div></div>
    <div class="balance" id="bones">0</div>
    <div class="zoo-balance">$ZOO: <span id="zoo-val">0.0000</span></div>
</div>

<div id="tab-game" class="tab-content active">
    <div class="click-area">
        <img src="dachshund.png" class="pet-image" id="pet">
        <div style="margin-top:15px; font-weight:bold; color:var(--accent)">–ö–ª–∏–∫: +<span id="tap-val">1</span> | ü¶¥/—á–∞—Å: <span id="pnl-val">0</span></div>
        <div class="energy-container">
            <div style="font-size:12px; margin-bottom:5px;">‚ö° <span id="en-cur">1000</span>/1000</div>
            <div class="energy-bar"><div id="energy-fill"></div></div>
        </div>
    </div>
</div>

<div id="tab-boost" class="tab-content">
    <h3 style="color:var(--gold)">–£–õ–£–ß–®–ï–ù–ò–Ø</h3>
    <div class="card">
        <div><b>–°–∏–ª–∞ —Ç–∞–ø–∞</b><br><small id="tap-cost">1000 ü¶¥</small></div>
        <button class="btn-action" onclick="buyUpgrade('tap')">LVL <span id="tap-lvl">1</span></button>
    </div>
    <div class="card">
        <div><b>–ê–≤—Ç–æ-–∫–æ—Ä–º—É—à–∫–∞</b><br><small id="pnl-cost">2000 ü¶¥</small></div>
        <button class="btn-action" onclick="buyUpgrade('pnl')">+50/—á–∞—Å</button>
    </div>
</div>

<div id="tab-market" class="tab-content">
    <h3 style="color:var(--gold)">–ö–ï–ô–°–´ (Lootbox)</h3>
    <div class="card" style="background: linear-gradient(to right, #1c1c2e, #2a2a4d);">
        <div><b>–û–±—ã—á–Ω—ã–π –±–æ–∫—Å</b><br><small>–¶–µ–Ω–∞: 10 $ZOO</small></div>
        <button class="btn-action" onclick="openBox()">–û–¢–ö–†–´–¢–¨</button>
    </div>

    <h3 style="color:var(--accent); margin-top:20px;">–¢–í–û–ò NFT</h3>
    <div id="nft-inventory" class="grid">
        </div>
</div>

<nav class="nav">
    <div class="nav-item active" onclick="switchTab('tab-game', this)"><i class="fas fa-paw"></i>–ò–≥—Ä–∞</div>
    <div class="nav-item" onclick="switchTab('tab-boost', this)"><i class="fas fa-rocket"></i>–ë—É—Å—Ç—ã</div>
    <div class="nav-item" onclick="switchTab('tab-market', this)"><i class="fas fa-box-open"></i>–ú–∞—Ä–∫–µ—Ç</div>
</nav>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAT4Qt--BNvqA953AQNUbbpiDHbSvO3BfE",
        authDomain: "zootopia-f046d.firebaseapp.com",
        projectId: "zootopia-f046d",
        storageBucket: "zootopia-f046d.firebasestorage.app",
        messagingSenderId: "531125789476",
        appId: "1:531125789476:web:7e504c4d855fd397fa49b1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const tg = window.Telegram.WebApp;

    const items = [
        { id: 'c1', name: 'Cyber Collar', bonus: 10, img: 'https://cdn-icons-png.flaticon.com/512/6065/6065011.png' },
        { id: 'c2', name: 'Neon Glasses', bonus: 25, img: 'https://cdn-icons-png.flaticon.com/512/3233/3233379.png' },
        { id: 'c3', name: 'Golden Bone', bonus: 100, img: 'https://cdn-icons-png.flaticon.com/512/2916/2916133.png' }
    ];

    const leagues = [
        { name: "–ë—Ä–æ–Ω–∑–∞", max: 10000 }, { name: "–°–µ—Ä–µ–±—Ä–æ", max: 100000 }, { name: "–ó–æ–ª–æ—Ç–æ", max: 1000000 }
    ];

    let state = { bones: 0, zoo: 0, energy: 1000, tapLvl: 1, pnl: 0, nfts: [], lastSave: Date.now() };

    async function init() {
        const uid = tg.initDataUnsafe?.user?.id?.toString() || "dev";
        const doc = await db.collection("users").doc(uid).get();
        if (doc.exists) state = { ...state, ...doc.data() };
        
        // –û—Ñ—Ñ–ª–∞–π–Ω –¥–æ—Ö–æ–¥
        const passed = (Date.now() - state.lastSave) / 3600000;
        if (state.pnl > 0) state.bones += (state.pnl * passed);

        updateUI();
        renderInventory();
        document.getElementById('loading').style.display = 'none';
    }

    function updateUI() {
        const nftBonus = state.nfts.reduce((sum, id) => sum + (items.find(i => i.id === id)?.bonus || 0), 0);
        const totalTap = state.tapLvl + nftBonus;

        document.getElementById('bones').innerText = Math.floor(state.bones).toLocaleString();
        document.getElementById('zoo-val').innerText = state.zoo.toFixed(4);
        document.getElementById('en-cur').innerText = Math.floor(state.energy);
        document.getElementById('energy-fill').style.width = (state.energy/10) + "%";
        document.getElementById('tap-val').innerText = totalTap;
        document.getElementById('tap-lvl').innerText = state.tapLvl;
        document.getElementById('pnl-val').innerText = state.pnl;

        // –õ–∏–≥–∏
        let l = leagues.find(l => state.bones < l.max) || leagues[leagues.length-1];
        document.getElementById('league-name').innerText = l.name;
        document.getElementById('league-progress').style.width = (state.bones / l.max * 100) + "%";
    }

    function handleTap() {
        const nftBonus = state.nfts.reduce((sum, id) => sum + (items.find(i => i.id === id)?.bonus || 0), 0);
        const power = state.tapLvl + nftBonus;
        if (state.energy >= 1) {
            state.bones += power;
            state.zoo += (power * 0.0001);
            state.energy -= 1;
            updateUI();
            tg.HapticFeedback.impactOccurred('light');
        }
    }

    function buyUpgrade(type) {
        if (type === 'tap') {
            let cost = state.tapLvl * 500;
            if (state.bones >= cost) { state.bones -= cost; state.tapLvl++; }
        } else {
            let cost = (state.pnl + 50) * 40;
            if (state.bones >= cost) { state.bones -= cost; state.pnl += 50; }
        }
        updateUI();
        saveToDb();
    }

    function openBox() {
        if (state.zoo < 10) return tg.showAlert("–ù—É–∂–Ω–æ 10 $ZOO!");
        state.zoo -= 10;
        
        const over = document.getElementById('unboxing');
        const box = document.getElementById('box-icon');
        const rew = document.getElementById('reward-info');
        
        over.style.display = 'flex';
        box.style.display = 'block';
        rew.classList.remove('show');

        setTimeout(() => {
            box.style.display = 'none';
            const item = items[Math.floor(Math.random()*items.length)];
            state.nfts.push(item.id);
            document.getElementById('rew-img').src = item.img;
            document.getElementById('rew-name').innerText = item.name;
            document.getElementById('rew-bonus').innerText = `+${item.bonus} –∫ —Å–∏–ª–µ –∫–ª–∏–∫–∞`;
            rew.classList.add('show');
            renderInventory();
            saveToDb();
        }, 2000);
    }

    function renderInventory() {
        const inv = document.getElementById('nft-inventory');
        inv.innerHTML = '';
        state.nfts.forEach(id => {
            const item = items.find(i => i.id === id);
            inv.innerHTML += `<div class="nft-card"><img src="${item.img}" class="nft-img-sm"><br><small>${item.name}</small></div>`;
        });
    }

    function closeUnboxing() { document.getElementById('unboxing').style.display = 'none'; updateUI(); }

    function switchTab(id, el) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
    }

    async function saveToDb() {
        state.lastSave = Date.now();
        const uid = tg.initDataUnsafe?.user?.id?.toString() || "dev";
        try { await db.collection("users").doc(uid).set(state); } catch(e){}
    }

    document.getElementById('pet').addEventListener('touchstart', (e) => { e.preventDefault(); handleTap(); });
    setInterval(() => { if(state.energy < 1000) { state.energy = Math.min(1000, state.energy + 2); updateUI(); } }, 1000);
    setInterval(() => { if(state.pnl > 0) { state.bones += (state.pnl/3600); updateUI(); } }, 1000);
    setInterval(saveToDb, 15000);
    init();
</script>
</body>
</html>
