<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zootopia Crypto</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@400;600&display=swap');
        :root { --gold: #FFD700; --accent: #00FFFF; --bg: #0A0A12; --card: #1C1C2E; }
        
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; touch-action: none; user-select: none; }
        .header { text-align: center; padding: 10px; background: rgba(0,0,0,0.8); border-bottom: 1px solid #333; }
        .balance { font-family: 'Orbitron'; font-size: 24px; color: var(--gold); }
        .zoo-balance { color: var(--accent); font-size: 14px; font-family: 'Orbitron'; margin-top: 5px; }
        
        .tab-content { display: none; height: calc(100vh - 180px); overflow-y: auto; padding: 20px; }
        .tab-content.active { display: block; }
        
        /* NFT Стили */
        .nft-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-bottom: 100px; }
        .nft-card { background: var(--card); border-radius: 15px; overflow: hidden; border: 1px solid rgba(0, 255, 255, 0.1); position: relative; }
        .nft-img { width: 100%; height: 120px; object-fit: cover; background: #222; }
        .nft-info { padding: 10px; text-align: center; }
        .nft-name { font-size: 11px; font-weight: bold; display: block; }
        .nft-bonus { font-size: 10px; color: #00FF88; margin: 4px 0; }
        .nft-price { color: var(--gold); font-size: 12px; font-family: 'Orbitron'; }
        
        .btn-nft { background: var(--accent); color: black; border: none; padding: 6px; border-radius: 6px; font-size: 10px; font-weight: bold; width: 100%; margin-top: 8px; cursor: pointer; }
        .btn-nft.owned { background: #444; color: #888; cursor: default; }

        .click-area { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 60vh; }
        .pet-image { width: 220px; transition: transform 0.05s; }
        
        .energy-container { width: 80%; margin-top: 30px; }
        .energy-bar-bg { width: 100%; height: 8px; background: #111; border-radius: 10px; overflow: hidden; }
        #energy-fill { height: 100%; background: var(--accent); width: 100%; transition: 0.3s; }

        .nav { position: fixed; bottom: 0; width: 100%; display: flex; background: #000; padding: 15px 0; border-top: 1px solid #222; }
        .nav-item { flex: 1; text-align: center; color: #555; font-size: 10px; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 4px; }

        #loading { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading">
    <h2 style="font-family:'Orbitron'; color:var(--gold)">ZOOTOPIA</h2>
    <p>Загрузка маркета...</p>
</div>

<div class="header">
    <div class="balance" id="bones">0</div>
    <div class="zoo-balance">$ZOO: <span id="zoo-val">0.0000</span></div>
</div>

<div id="tab-game" class="tab-content active">
    <div class="click-area">
        <img src="dachshund.png" class="pet-image" id="pet">
        <div style="margin-top: 20px; font-weight: bold; color: var(--accent);">Клик: +<span id="total-tap">1</span></div>
        <div class="energy-container">
            <div style="font-size: 12px; margin-bottom: 5px;">⚡ <span id="energy-val">1000</span> / 1000</div>
            <div class="energy-bar-bg"><div id="energy-fill"></div></div>
        </div>
    </div>
</div>

<div id="tab-nft" class="tab-content">
    <h3 style="color:var(--gold); font-family:'Orbitron';">NFT МАГАЗИН</h3>
    <p style="font-size: 10px; color: #888; margin-bottom: 15px;">NFT увеличивают силу клика навсегда!</p>
    <div class="nft-grid" id="nft-market">
        </div>
</div>

<nav class="nav">
    <div class="nav-item active" onclick="switchTab('tab-game', this)"><i class="fas fa-paw"></i>Игра</div>
    <div class="nav-item" onclick="switchTab('tab-nft', this)"><i class="fas fa-shopping-cart"></i>NFT Маркет</div>
</nav>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAT4Qt--BNvqA953AQNUbbpiDHbSvO3BfE",
        authDomain: "zootopia-f046d.firebaseapp.com",
        projectId: "zootopia-f046d",
        storageBucket: "zootopia-f046d.firebasestorage.app",
        messagingSenderId: "531125789476",
        appId: "1:531125789476:web:7e504c4d855fd397fa49b1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const tg = window.Telegram.WebApp;

    const uid = tg.initDataUnsafe?.user?.id?.toString() || "dev_test";
    
    // Список доступных NFT
    const nftCatalog = [
        { id: 'n1', name: 'Cyber Collar', price: 10, bonus: 5, img: 'https://img.freepik.com/free-vector/cyber-dog-concept-illustration_114360-18118.jpg' },
        { id: 'n2', name: 'Neon Glasses', price: 50, bonus: 15, img: 'https://img.freepik.com/free-photo/view-neon-illuminated-dog_23-2150712530.jpg' },
        { id: 'n3', name: 'Rocket Pack', price: 250, bonus: 50, img: 'https://img.freepik.com/free-vector/dog-space-suit-illustration_114360-7850.jpg' },
        { id: 'n4', name: 'Zootopia King', price: 1000, bonus: 200, img: 'https://img.freepik.com/free-photo/cool-dog-with-sunglasses-gold-chain_23-2150165917.jpg' }
    ];

    let state = { bones: 0, zoo: 0, energy: 1000, tapPower: 1, nfts: [] };

    async function init() {
        try {
            const doc = await db.collection("users").doc(uid).get();
            if (doc.exists) state = { ...state, ...doc.data() };
            renderNFTs();
            updateUI();
        } catch (e) {}
        document.getElementById('loading').style.display = 'none';
    }

    function calculateTotalTap() {
        let nftBonus = 0;
        state.nfts.forEach(nftId => {
            const nft = nftCatalog.find(item => item.id === nftId);
            if (nft) nftBonus += nft.bonus;
        });
        return state.tapPower + nftBonus;
    }

    function updateUI() {
        const totalTap = calculateTotalTap();
        document.getElementById('bones').innerText = Math.floor(state.bones).toLocaleString();
        document.getElementById('zoo-val').innerText = state.zoo.toFixed(4);
        document.getElementById('energy-val').innerText = Math.floor(state.energy);
        document.getElementById('energy-fill').style.width = (state.energy / 10) + "%";
        document.getElementById('total-tap').innerText = totalTap;
    }

    function renderNFTs() {
        const container = document.getElementById('nft-market');
        container.innerHTML = '';
        nftCatalog.forEach(nft => {
            const isOwned = state.nfts.includes(nft.id);
            container.innerHTML += `
                <div class="nft-card">
                    <img src="${nft.img}" class="nft-img">
                    <div class="nft-info">
                        <span class="nft-name">${nft.name}</span>
                        <div class="nft-bonus">+${nft.bonus} к клику</div>
                        <div class="nft-price">${nft.price} $ZOO</div>
                        <button class="btn-nft ${isOwned ? 'owned' : ''}" 
                                onclick="${isOwned ? '' : `buyNFT('${nft.id}', ${nft.price})`}">
                            ${isOwned ? 'КУПЛЕНО' : 'КУПИТЬ'}
                        </button>
                    </div>
                </div>
            `;
        });
    }

    function buyNFT(id, price) {
        if (state.zoo >= price) {
            state.zoo -= price;
            state.nfts.push(id);
            tg.HapticFeedback.notificationOccurred('success');
            renderNFTs();
            updateUI();
            saveToDb();
        } else {
            tg.showAlert("Недостаточно $ZOO! Продолжай кликать.");
        }
    }

    function handleTap() {
        const power = calculateTotalTap();
        if (state.energy >= 1) {
            state.bones += power;
            state.zoo += (power * 0.001); // Начисление зоокоинов за клик
            state.energy -= 1;
            updateUI();
            tg.HapticFeedback.impactOccurred('light');
        }
    }

    function switchTab(id, el) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
    }

    async function saveToDb() { try { await db.collection("users").doc(uid).set(state); } catch(e){} }

    document.getElementById('pet').addEventListener('touchstart', (e) => {
        e.preventDefault();
        handleTap();
    });

    setInterval(() => { if(state.energy < 1000) { state.energy = Math.min(1000, state.energy + 3); updateUI(); } }, 1000);
    setInterval(saveToDb, 15000);

    init();
</script>
</body>
</html>
