<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zootopia Crypto</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@400;600&display=swap');
        :root { --gold: #FFD700; --accent: #00FFFF; --bg: #0A0A12; --card: #1C1C2E; }
        
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; touch-action: none; user-select: none; }
        .header { text-align: center; padding: 10px; background: rgba(0,0,0,0.8); border-bottom: 1px solid #333; }
        
        .league-info { font-size: 11px; color: var(--accent); margin-bottom: 4px; font-weight: bold; letter-spacing: 1px; }
        .league-bar-bg { width: 50%; height: 4px; background: #333; margin: 0 auto 8px; border-radius: 2px; }
        #league-progress { height: 100%; background: var(--gold); width: 0%; border-radius: 2px; transition: 0.5s; }

        .balance { font-family: 'Orbitron'; font-size: 32px; color: var(--gold); text-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        
        .tab-content { display: none; height: calc(100vh - 180px); overflow-y: auto; padding: 20px; }
        .tab-content.active { display: block; }
        
        /* Главная область клика */
        .click-area { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 65vh; position: relative; }
        
        /* Увеличенная такса */
        .pet-image { width: 260px; filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.2)); cursor: pointer; transition: transform 0.05s; -webkit-tap-highlight-color: transparent; }
        .pet-image:active { transform: scale(0.95); }
        
        /* Энергия внизу */
        .energy-container { position: absolute; bottom: 20px; width: 80%; text-align: center; }
        .energy-bar-bg { width: 100%; height: 12px; background: #1a1a2e; border-radius: 10px; border: 1px solid #333; overflow: hidden; margin-top: 5px; }
        #energy-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #0088ff); width: 100%; transition: width 0.2s; }

        /* Всплывающие цифры */
        .tap-number { position: absolute; color: white; font-family: 'Orbitron'; font-weight: bold; pointer-events: none; animation: floatUp 0.8s ease-out forwards; z-index: 100; font-size: 24px; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }

        .nav { position: fixed; bottom: 0; width: 100%; display: flex; background: #111; padding: 12px 0; border-top: 1px solid #333; }
        .nav-item { flex: 1; text-align: center; color: #666; font-size: 11px; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; display: block; }

        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .btn-buy { background: var(--accent); color: black; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; }
        #loading { position: fixed; inset: 0; background: var(--bg); z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading">
    <h2 style="font-family:'Orbitron'; color:var(--gold)">ZOOTOPIA</h2>
    <p>Пробуждение таксы...</p>
</div>

<div class="header">
    <div class="league-info" id="league-name">Бронзовая Лига</div>
    <div class="league-bar-bg"><div id="league-progress"></div></div>
    <div class="balance" id="bones">0</div>
</div>

<div id="tab-game" class="tab-content active">
    <div class="click-area" id="tap-zone">
        <img src="dachshund.png" class="pet-image" id="pet">
        
        <div class="energy-container">
            <div style="font-size: 14px; font-weight: bold;">⚡ <span id="energy-val">1000</span> / 1000</div>
            <div class="energy-bar-bg">
                <div id="energy-fill"></div>
            </div>
            <div style="font-size: 10px; color: #888; margin-top: 4px;">Регенерация: +<span id="reg-val">5</span>/сек</div>
        </div>
    </div>
</div>

<div id="tab-upgrades" class="tab-content">
    <h3 style="color:var(--gold); font-family:'Orbitron'">МАГАЗИН</h3>
    <div class="card">
        <div><b>Сила клика</b><br><small>Уровень <span id="lvl-tap">1</span></small></div>
        <button class="btn-buy" onclick="buyUpgrade()">УЛУЧШИТЬ</button>
    </div>
</div>

<div id="tab-leaderboard" class="tab-content">
    <h3 style="color:var(--gold); font-family:'Orbitron'; text-align:center;">ЛИДЕРЫ</h3>
    <div id="leaderboard-list"></div>
</div>

<nav class="nav">
    <div class="nav-item active" onclick="switchTab('tab-game', this)"><i class="fas fa-paw"></i>Игра</div>
    <div class="nav-item" onclick="switchTab('tab-upgrades', this)"><i class="fas fa-rocket"></i>Бусты</div>
    <div class="nav-item" onclick="switchTab('tab-leaderboard', this)"><i class="fas fa-trophy"></i>Топ</div>
</nav>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAT4Qt--BNvqA953AQNUbbpiDHbSvO3BfE",
        authDomain: "zootopia-f046d.firebaseapp.com",
        projectId: "zootopia-f046d",
        storageBucket: "zootopia-f046d.firebasestorage.app",
        messagingSenderId: "531125789476",
        appId: "1:531125789476:web:7e504c4d855fd397fa49b1"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const tg = window.Telegram.WebApp;
    tg.expand();

    const uid = tg.initDataUnsafe?.user?.id?.toString() || "dev_test";
    const firstName = tg.initDataUnsafe?.user?.first_name || "Dachshund Lover";

    const leagues = [
        { name: "Бронзовая Лига", min: 0, max: 10000, reg: 3 },
        { name: "Серебряная Лига", min: 10000, max: 50000, reg: 5 },
        { name: "Золотая Лига", min: 50000, max: 200000, reg: 8 },
        { name: "Алмазная Лига", min: 200000, max: 1000000, reg: 12 }
    ];

    let state = { bones: 0, energy: 1000, tapPower: 1, name: firstName, leagueIdx: 0 };

    async function init() {
        try {
            const doc = await db.collection("users").doc(uid).get();
            if (doc.exists) state = { ...state, ...doc.data() };
            updateUI();
        } catch (e) {}
        document.getElementById('loading').style.display = 'none';
    }

    function updateUI() {
        document.getElementById('bones').innerText = Math.floor(state.bones).toLocaleString();
        document.getElementById('energy-val').innerText = Math.floor(state.energy);
        document.getElementById('energy-fill').style.width = (state.energy / 10) + "%";
        document.getElementById('lvl-tap').innerText = state.tapPower;

        let league = leagues[state.leagueIdx];
        if (state.bones >= league.max && state.leagueIdx < leagues.length - 1) {
            state.leagueIdx++;
            league = leagues[state.leagueIdx];
            tg.showPopup({ title: 'Новый уровень!', message: `Вы перешли в ${league.name}` });
        }

        document.getElementById('league-name').innerText = league.name;
        document.getElementById('reg-val').innerText = league.reg;
        let prog = ((state.bones - league.min) / (league.max - league.min)) * 100;
        document.getElementById('league-progress').style.width = Math.min(100, prog) + "%";
    }

    function handleTap(e) {
        if (state.energy >= state.tapPower) {
            state.bones += state.tapPower;
            state.energy -= state.tapPower;
            
            // Анимация цифр
            const num = document.createElement('div');
            num.className = 'tap-number';
            num.innerText = `+${state.tapPower}`;
            num.style.left = (e.clientX || e.touches[0].clientX) + 'px';
            num.style.top = (e.clientY || e.touches[0].clientY) + 'px';
            document.body.appendChild(num);
            setTimeout(() => num.remove(), 800);

            tg.HapticFeedback.impactOccurred('medium');
            updateUI();
        }
    }

    function buyUpgrade() {
        let cost = state.tapPower * 1500;
        if (state.bones >= cost) {
            state.bones -= cost;
            state.tapPower++;
            saveToDb();
            updateUI();
        }
    }

    async function saveToDb() { try { await db.collection("users").doc(uid).set(state); } catch(e){} }

    function switchTab(id, el) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
    }

    document.getElementById('pet').addEventListener('touchstart', (e) => {
        e.preventDefault();
        handleTap(e);
    });

    setInterval(() => {
        let reg = leagues[state.leagueIdx].reg;
        if (state.energy < 1000) {
            state.energy = Math.min(1000, state.energy + reg);
            updateUI();
        }
    }, 1000);

    setInterval(saveToDb, 10000);
    init();
</script>
</body>
</html>
